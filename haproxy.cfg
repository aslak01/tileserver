global
    log stdout format raw local0 info
    maxconn 256

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  60s

# ── Tile cache (HAProxy built-in, since 1.8) ────────────────────────────────

cache tiles
    total-max-size  512   # MB in RAM
    max-object-size 256   # KB per tile
    max-age         604800  # 7 days in seconds

# ── Frontend: accept requests on port 8080 ──────────────────────────────────

frontend ft_tiles
    bind *:8080

    # Rewrite /{z}/{x}/{y}.png → /styles/osm-bright/{z}/{x}/{y}.png
    # Matches 1-2 digit z, multi-digit x, multi-digit y
    acl is_tile_req path_reg ^/[0-9]{1,2}/[0-9]+/[0-9]+\.png$
    http-request set-path /styles/osm-bright%[path] if is_tile_req

    # Rewrite /{z}/{x}/{y}@2x.png → /styles/osm-bright/{z}/{x}/{y}@2x.png
    acl is_tile_2x  path_reg ^/[0-9]{1,2}/[0-9]+/[0-9]+@2x\.png$
    http-request set-path /styles/osm-bright%[path] if is_tile_2x

    # Serve tiles from cache
    http-request cache-use tiles
    http-response cache-store tiles

    # CORS headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, OPTIONS"

    # Cache-control for clients (on all responses, since all traffic is tiles)
    http-response set-header Cache-Control "public, max-age=604800"

    default_backend bk_tileserver

# ── Backend: tileserver-gl on localhost:8081 ─────────────────────────────────

backend bk_tileserver
    server tileserver "${TILESERVER_HOST}":8081 check
