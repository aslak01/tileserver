global
    log stdout format raw local0 info
    maxconn 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  60s

# ── Tile cache (HAProxy built-in, since 1.8) ────────────────────────────────

cache tiles
    total-max-size  512   # MB in RAM
    max-object-size 256   # KB per tile
    max-age         604800  # 7 days in seconds

# ── Frontend: accept requests on port 8080 ──────────────────────────────────

frontend ft_tiles
    bind *:8080

    # Vector tiles: /{z}/{x}/{y}.pbf → /data/v3/{z}/{x}/{y}.pbf
    acl is_vector_req path_reg ^/[0-9]{1,2}/[0-9]+/[0-9]+\.pbf$
    http-request set-path /data/v3%[path] if is_vector_req

    # Serve tiles from cache
    http-request cache-use tiles
    http-response cache-store tiles

    # CORS headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, OPTIONS"

    # Cache-control for clients
    http-response set-header Cache-Control "public, max-age=604800"

    default_backend bk_tileserver

# ── Backend: tileserver-gl on localhost:8081 ─────────────────────────────────

backend bk_tileserver
    server tileserver 127.0.0.1:8081 check
